SRPGLayer = Layer:extend()

function SRPGLayer:new()
    SRPGLayer.super.new(self)
    self.game_ended = false
    self.layer_name = "SRPGLayer"
    self.active_mode = 'overview'
    self.hover_ui = nil

    -- cursor placement
    self.cursor_tile_x = 8
    self.cursor_tile_y = 14
    self.cursor_tile_target_x = 8
    self.cursor_tile_target_y = 14
    self.cursor_tile_anim_accumulator = 0
    self.cursor_is_turbo = false
    self.cursor_img = love.graphics.newImage('gfx/gui/pointer.png')

    -- map loading and dimensions
    self.map_img_file = 'gfx/map/1-1.png'
    self.map_img = love.graphics.newImage(self.map_img_file)
    self.map_img_width = 1944
    self.map_img_height = 696
    camera:setBounds(0, 0, self.map_img_width * constants.pixel_integer_scale, self.map_img_height * constants.pixel_integer_scale)
    self.tile_width_count = self.map_img_width / constants.pixel_tile_width
    self.tile_height_count = self.map_img_height / constants.pixel_tile_height
    log(lume.format("[{1}] loaded map {2} ({3}x{4}px, {5}x{6} tile count)", {self.layer_name, self.map_img_file, self.map_img_width, self.map_img_height, self.tile_width_count, self.tile_height_count }))

    -- selection mode stuff
    self.selection_intention = 'move' -- 'move' or 'attack'
    self.allowed_tiles = {}
    self.restricted_tiles = lume.deserialize('{[1]={["y"]=0,["x"]=1},[2]={["y"]=0,["x"]=2},[3]={["y"]=0,["x"]=3},[4]={["y"]=0,["x"]=4},[5]={["y"]=0,["x"]=5},[6]={["y"]=0,["x"]=6},[7]={["y"]=0,["x"]=7},[8]={["y"]=0,["x"]=8},[9]={["y"]=0,["x"]=9},[10]={["y"]=0,["x"]=10},[11]={["y"]=0,["x"]=11},[12]={["y"]=0,["x"]=12},[13]={["y"]=0,["x"]=13},[14]={["y"]=0,["x"]=14},[15]={["y"]=0,["x"]=15},[16]={["y"]=0,["x"]=16},[17]={["y"]=0,["x"]=17},[18]={["y"]=0,["x"]=18},[19]={["y"]=0,["x"]=19},[20]={["y"]=0,["x"]=20},[21]={["y"]=0,["x"]=21},[22]={["y"]=0,["x"]=22},[23]={["y"]=0,["x"]=23},[24]={["y"]=0,["x"]=24},[25]={["y"]=0,["x"]=25},[26]={["y"]=0,["x"]=26},[27]={["y"]=0,["x"]=27},[28]={["y"]=0,["x"]=28},[29]={["y"]=0,["x"]=29},[30]={["y"]=0,["x"]=30},[31]={["y"]=0,["x"]=31},[32]={["y"]=0,["x"]=32},[33]={["y"]=0,["x"]=33},[34]={["y"]=0,["x"]=34},[35]={["y"]=0,["x"]=35},[36]={["y"]=0,["x"]=36},[37]={["y"]=0,["x"]=37},[38]={["y"]=0,["x"]=38},[39]={["y"]=0,["x"]=39},[40]={["y"]=0,["x"]=40},[41]={["y"]=0,["x"]=41},[42]={["y"]=0,["x"]=42},[43]={["y"]=0,["x"]=43},[44]={["y"]=0,["x"]=44},[45]={["y"]=0,["x"]=45},[46]={["y"]=0,["x"]=46},[47]={["y"]=0,["x"]=47},[48]={["y"]=0,["x"]=48},[49]={["y"]=0,["x"]=49},[50]={["y"]=0,["x"]=50},[51]={["y"]=0,["x"]=51},[52]={["y"]=0,["x"]=52},[53]={["y"]=0,["x"]=53},[54]={["y"]=0,["x"]=54},[55]={["y"]=0,["x"]=55},[56]={["y"]=0,["x"]=56},[57]={["y"]=0,["x"]=57},[58]={["y"]=0,["x"]=58},[59]={["y"]=0,["x"]=59},[60]={["y"]=0,["x"]=60},[61]={["y"]=0,["x"]=61},[62]={["y"]=0,["x"]=62},[63]={["y"]=0,["x"]=63},[64]={["y"]=0,["x"]=64},[65]={["y"]=0,["x"]=65},[66]={["y"]=0,["x"]=66},[67]={["y"]=0,["x"]=67},[68]={["y"]=0,["x"]=68},[69]={["y"]=0,["x"]=69},[70]={["y"]=0,["x"]=70},[71]={["y"]=0,["x"]=71},[72]={["y"]=0,["x"]=72},[73]={["y"]=0,["x"]=73},[74]={["y"]=0,["x"]=74},[75]={["y"]=0,["x"]=75},[76]={["y"]=0,["x"]=76},[77]={["y"]=0,["x"]=77},[78]={["y"]=0,["x"]=78},[79]={["y"]=0,["x"]=79},[80]={["y"]=0,["x"]=80},[81]={["y"]=0,["x"]=81},[82]={["y"]=2,["x"]=1},[83]={["y"]=2,["x"]=2},[84]={["y"]=2,["x"]=3},[85]={["y"]=2,["x"]=4},[86]={["y"]=2,["x"]=5},[87]={["y"]=2,["x"]=6},[88]={["y"]=2,["x"]=7},[89]={["y"]=2,["x"]=8},[90]={["y"]=2,["x"]=9},[91]={["y"]=2,["x"]=10},[92]={["y"]=2,["x"]=11},[93]={["y"]=2,["x"]=12},[94]={["y"]=2,["x"]=13},[95]={["y"]=2,["x"]=14},[96]={["y"]=2,["x"]=15},[97]={["y"]=2,["x"]=16},[98]={["y"]=2,["x"]=17},[99]={["y"]=2,["x"]=18},[100]={["y"]=2,["x"]=19},[101]={["y"]=2,["x"]=20},[102]={["y"]=2,["x"]=21},[103]={["y"]=2,["x"]=22},[104]={["y"]=2,["x"]=23},[105]={["y"]=2,["x"]=24},[106]={["y"]=2,["x"]=25},[107]={["y"]=2,["x"]=26},[108]={["y"]=2,["x"]=27},[109]={["y"]=2,["x"]=28},[110]={["y"]=2,["x"]=29},[111]={["y"]=2,["x"]=30},[112]={["y"]=2,["x"]=31},[113]={["y"]=2,["x"]=32},[114]={["y"]=2,["x"]=33},[115]={["y"]=2,["x"]=34},[116]={["y"]=2,["x"]=35},[117]={["y"]=2,["x"]=36},[118]={["y"]=2,["x"]=37},[119]={["y"]=2,["x"]=38},[120]={["y"]=2,["x"]=39},[121]={["y"]=2,["x"]=40},[122]={["y"]=2,["x"]=41},[123]={["y"]=2,["x"]=42},[124]={["y"]=2,["x"]=43},[125]={["y"]=2,["x"]=44},[126]={["y"]=2,["x"]=45},[127]={["y"]=2,["x"]=46},[128]={["y"]=2,["x"]=47},[129]={["y"]=2,["x"]=48},[130]={["y"]=2,["x"]=49},[131]={["y"]=2,["x"]=50},[132]={["y"]=2,["x"]=51},[133]={["y"]=2,["x"]=52},[134]={["y"]=2,["x"]=53},[135]={["y"]=2,["x"]=54},[136]={["y"]=2,["x"]=55},[137]={["y"]=2,["x"]=56},[138]={["y"]=2,["x"]=57},[139]={["y"]=2,["x"]=58},[140]={["y"]=2,["x"]=59},[141]={["y"]=2,["x"]=60},[142]={["y"]=2,["x"]=61},[143]={["y"]=2,["x"]=62},[144]={["y"]=2,["x"]=63},[145]={["y"]=2,["x"]=64},[146]={["y"]=2,["x"]=65},[147]={["y"]=2,["x"]=66},[148]={["y"]=2,["x"]=67},[149]={["y"]=2,["x"]=68},[150]={["y"]=2,["x"]=69},[151]={["y"]=2,["x"]=70},[152]={["y"]=2,["x"]=71},[153]={["y"]=2,["x"]=72},[154]={["y"]=2,["x"]=73},[155]={["y"]=2,["x"]=74},[156]={["y"]=2,["x"]=75},[157]={["y"]=2,["x"]=76},[158]={["y"]=2,["x"]=77},[159]={["y"]=2,["x"]=78},[160]={["y"]=2,["x"]=79},[161]={["y"]=2,["x"]=80},[162]={["y"]=2,["x"]=81},[163]={["y"]=1,["x"]=1},[164]={["y"]=1,["x"]=2},[165]={["y"]=1,["x"]=3},[166]={["y"]=1,["x"]=4},[167]={["y"]=1,["x"]=5},[168]={["y"]=1,["x"]=6},[169]={["y"]=1,["x"]=7},[170]={["y"]=1,["x"]=8},[171]={["y"]=1,["x"]=9},[172]={["y"]=1,["x"]=10},[173]={["y"]=1,["x"]=11},[174]={["y"]=1,["x"]=12},[175]={["y"]=1,["x"]=13},[176]={["y"]=1,["x"]=14},[177]={["y"]=1,["x"]=15},[178]={["y"]=1,["x"]=16},[179]={["y"]=1,["x"]=17},[180]={["y"]=1,["x"]=18},[181]={["y"]=1,["x"]=19},[182]={["y"]=1,["x"]=20},[183]={["y"]=1,["x"]=21},[184]={["y"]=1,["x"]=22},[185]={["y"]=1,["x"]=23},[186]={["y"]=1,["x"]=24},[187]={["y"]=1,["x"]=25},[188]={["y"]=1,["x"]=26},[189]={["y"]=1,["x"]=27},[190]={["y"]=1,["x"]=28},[191]={["y"]=1,["x"]=29},[192]={["y"]=1,["x"]=30},[193]={["y"]=1,["x"]=31},[194]={["y"]=1,["x"]=32},[195]={["y"]=1,["x"]=33},[196]={["y"]=1,["x"]=34},[197]={["y"]=1,["x"]=35},[198]={["y"]=1,["x"]=36},[199]={["y"]=1,["x"]=37},[200]={["y"]=1,["x"]=38},[201]={["y"]=1,["x"]=39},[202]={["y"]=1,["x"]=40},[203]={["y"]=1,["x"]=41},[204]={["y"]=1,["x"]=42},[205]={["y"]=1,["x"]=43},[206]={["y"]=1,["x"]=44},[207]={["y"]=1,["x"]=45},[208]={["y"]=1,["x"]=46},[209]={["y"]=1,["x"]=47},[210]={["y"]=1,["x"]=48},[211]={["y"]=1,["x"]=49},[212]={["y"]=1,["x"]=50},[213]={["y"]=1,["x"]=51},[214]={["y"]=1,["x"]=52},[215]={["y"]=1,["x"]=53},[216]={["y"]=1,["x"]=54},[217]={["y"]=1,["x"]=55},[218]={["y"]=1,["x"]=56},[219]={["y"]=1,["x"]=57},[220]={["y"]=1,["x"]=58},[221]={["y"]=1,["x"]=59},[222]={["y"]=1,["x"]=60},[223]={["y"]=1,["x"]=61},[224]={["y"]=1,["x"]=62},[225]={["y"]=1,["x"]=63},[226]={["y"]=1,["x"]=64},[227]={["y"]=1,["x"]=65},[228]={["y"]=1,["x"]=66},[229]={["y"]=1,["x"]=67},[230]={["y"]=1,["x"]=68},[231]={["y"]=1,["x"]=69},[232]={["y"]=1,["x"]=70},[233]={["y"]=1,["x"]=71},[234]={["y"]=1,["x"]=72},[235]={["y"]=1,["x"]=73},[236]={["y"]=1,["x"]=74},[237]={["y"]=1,["x"]=75},[238]={["y"]=1,["x"]=76},[239]={["y"]=1,["x"]=77},[240]={["y"]=1,["x"]=78},[241]={["y"]=1,["x"]=79},[242]={["y"]=1,["x"]=80},[243]={["y"]=1,["x"]=81},[244]={["y"]=26,["x"]=1},[245]={["y"]=26,["x"]=2},[246]={["y"]=26,["x"]=3},[247]={["y"]=26,["x"]=4},[248]={["y"]=26,["x"]=5},[249]={["y"]=26,["x"]=6},[250]={["y"]=26,["x"]=7},[251]={["y"]=26,["x"]=8},[252]={["y"]=26,["x"]=9},[253]={["y"]=26,["x"]=10},[254]={["y"]=26,["x"]=11},[255]={["y"]=26,["x"]=12},[256]={["y"]=26,["x"]=13},[257]={["y"]=26,["x"]=14},[258]={["y"]=26,["x"]=15},[259]={["y"]=26,["x"]=16},[260]={["y"]=26,["x"]=17},[261]={["y"]=26,["x"]=18},[262]={["y"]=26,["x"]=19},[263]={["y"]=26,["x"]=20},[264]={["y"]=26,["x"]=21},[265]={["y"]=26,["x"]=22},[266]={["y"]=26,["x"]=23},[267]={["y"]=26,["x"]=24},[268]={["y"]=26,["x"]=25},[269]={["y"]=26,["x"]=26},[270]={["y"]=26,["x"]=27},[271]={["y"]=26,["x"]=28},[272]={["y"]=26,["x"]=29},[273]={["y"]=26,["x"]=30},[274]={["y"]=26,["x"]=31},[275]={["y"]=26,["x"]=32},[276]={["y"]=26,["x"]=33},[277]={["y"]=26,["x"]=34},[278]={["y"]=26,["x"]=35},[279]={["y"]=26,["x"]=36},[280]={["y"]=26,["x"]=37},[281]={["y"]=26,["x"]=38},[282]={["y"]=26,["x"]=39},[283]={["y"]=26,["x"]=40},[284]={["y"]=26,["x"]=41},[285]={["y"]=26,["x"]=42},[286]={["y"]=26,["x"]=43},[287]={["y"]=26,["x"]=44},[288]={["y"]=26,["x"]=45},[289]={["y"]=26,["x"]=46},[290]={["y"]=26,["x"]=47},[291]={["y"]=26,["x"]=48},[292]={["y"]=26,["x"]=49},[293]={["y"]=26,["x"]=50},[294]={["y"]=26,["x"]=51},[295]={["y"]=26,["x"]=52},[296]={["y"]=26,["x"]=53},[297]={["y"]=26,["x"]=54},[298]={["y"]=26,["x"]=55},[299]={["y"]=26,["x"]=56},[300]={["y"]=26,["x"]=57},[301]={["y"]=26,["x"]=58},[302]={["y"]=26,["x"]=59},[303]={["y"]=26,["x"]=60},[304]={["y"]=26,["x"]=61},[305]={["y"]=26,["x"]=62},[306]={["y"]=26,["x"]=63},[307]={["y"]=26,["x"]=64},[308]={["y"]=26,["x"]=65},[309]={["y"]=26,["x"]=66},[310]={["y"]=26,["x"]=67},[311]={["y"]=26,["x"]=68},[312]={["y"]=26,["x"]=69},[313]={["y"]=26,["x"]=70},[314]={["y"]=26,["x"]=71},[315]={["y"]=26,["x"]=72},[316]={["y"]=26,["x"]=73},[317]={["y"]=26,["x"]=74},[318]={["y"]=26,["x"]=75},[319]={["y"]=26,["x"]=76},[320]={["y"]=26,["x"]=77},[321]={["y"]=26,["x"]=78},[322]={["y"]=26,["x"]=79},[323]={["y"]=26,["x"]=80},[324]={["y"]=26,["x"]=81},[325]={["y"]=27,["x"]=1},[326]={["y"]=27,["x"]=2},[327]={["y"]=27,["x"]=3},[328]={["y"]=27,["x"]=4},[329]={["y"]=27,["x"]=5},[330]={["y"]=27,["x"]=6},[331]={["y"]=27,["x"]=7},[332]={["y"]=27,["x"]=8},[333]={["y"]=27,["x"]=9},[334]={["y"]=27,["x"]=10},[335]={["y"]=27,["x"]=11},[336]={["y"]=27,["x"]=12},[337]={["y"]=27,["x"]=13},[338]={["y"]=27,["x"]=14},[339]={["y"]=27,["x"]=15},[340]={["y"]=27,["x"]=16},[341]={["y"]=27,["x"]=17},[342]={["y"]=27,["x"]=18},[343]={["y"]=27,["x"]=19},[344]={["y"]=27,["x"]=20},[345]={["y"]=27,["x"]=21},[346]={["y"]=27,["x"]=22},[347]={["y"]=27,["x"]=23},[348]={["y"]=27,["x"]=24},[349]={["y"]=27,["x"]=25},[350]={["y"]=27,["x"]=26},[351]={["y"]=27,["x"]=27},[352]={["y"]=27,["x"]=28},[353]={["y"]=27,["x"]=29},[354]={["y"]=27,["x"]=30},[355]={["y"]=27,["x"]=31},[356]={["y"]=27,["x"]=32},[357]={["y"]=27,["x"]=33},[358]={["y"]=27,["x"]=34},[359]={["y"]=27,["x"]=35},[360]={["y"]=27,["x"]=36},[361]={["y"]=27,["x"]=37},[362]={["y"]=27,["x"]=38},[363]={["y"]=27,["x"]=39},[364]={["y"]=27,["x"]=40},[365]={["y"]=27,["x"]=41},[366]={["y"]=27,["x"]=42},[367]={["y"]=27,["x"]=43},[368]={["y"]=27,["x"]=44},[369]={["y"]=27,["x"]=45},[370]={["y"]=27,["x"]=46},[371]={["y"]=27,["x"]=47},[372]={["y"]=27,["x"]=48},[373]={["y"]=27,["x"]=49},[374]={["y"]=27,["x"]=50},[375]={["y"]=27,["x"]=51},[376]={["y"]=27,["x"]=52},[377]={["y"]=27,["x"]=53},[378]={["y"]=27,["x"]=54},[379]={["y"]=27,["x"]=55},[380]={["y"]=27,["x"]=56},[381]={["y"]=27,["x"]=57},[382]={["y"]=27,["x"]=58},[383]={["y"]=27,["x"]=59},[384]={["y"]=27,["x"]=60},[385]={["y"]=27,["x"]=61},[386]={["y"]=27,["x"]=62},[387]={["y"]=27,["x"]=63},[388]={["y"]=27,["x"]=64},[389]={["y"]=27,["x"]=65},[390]={["y"]=27,["x"]=66},[391]={["y"]=27,["x"]=67},[392]={["y"]=27,["x"]=68},[393]={["y"]=27,["x"]=69},[394]={["y"]=27,["x"]=70},[395]={["y"]=27,["x"]=71},[396]={["y"]=27,["x"]=72},[397]={["y"]=27,["x"]=73},[398]={["y"]=27,["x"]=74},[399]={["y"]=27,["x"]=75},[400]={["y"]=27,["x"]=76},[401]={["y"]=27,["x"]=77},[402]={["y"]=27,["x"]=78},[403]={["y"]=27,["x"]=79},[404]={["y"]=27,["x"]=80},[405]={["y"]=27,["x"]=81},[406]={["y"]=28,["x"]=1},[407]={["y"]=28,["x"]=2},[408]={["y"]=28,["x"]=3},[409]={["y"]=28,["x"]=4},[410]={["y"]=28,["x"]=5},[411]={["y"]=28,["x"]=6},[412]={["y"]=28,["x"]=7},[413]={["y"]=28,["x"]=8},[414]={["y"]=28,["x"]=9},[415]={["y"]=28,["x"]=10},[416]={["y"]=28,["x"]=11},[417]={["y"]=28,["x"]=12},[418]={["y"]=28,["x"]=13},[419]={["y"]=28,["x"]=14},[420]={["y"]=28,["x"]=15},[421]={["y"]=28,["x"]=16},[422]={["y"]=28,["x"]=17},[423]={["y"]=28,["x"]=18},[424]={["y"]=28,["x"]=19},[425]={["y"]=28,["x"]=20},[426]={["y"]=28,["x"]=21},[427]={["y"]=28,["x"]=22},[428]={["y"]=28,["x"]=23},[429]={["y"]=28,["x"]=24},[430]={["y"]=28,["x"]=25},[431]={["y"]=28,["x"]=26},[432]={["y"]=28,["x"]=27},[433]={["y"]=28,["x"]=28},[434]={["y"]=28,["x"]=29},[435]={["y"]=28,["x"]=30},[436]={["y"]=28,["x"]=31},[437]={["y"]=28,["x"]=32},[438]={["y"]=28,["x"]=33},[439]={["y"]=28,["x"]=34},[440]={["y"]=28,["x"]=35},[441]={["y"]=28,["x"]=36},[442]={["y"]=28,["x"]=37},[443]={["y"]=28,["x"]=38},[444]={["y"]=28,["x"]=39},[445]={["y"]=28,["x"]=40},[446]={["y"]=28,["x"]=41},[447]={["y"]=28,["x"]=42},[448]={["y"]=28,["x"]=43},[449]={["y"]=28,["x"]=44},[450]={["y"]=28,["x"]=45},[451]={["y"]=28,["x"]=46},[452]={["y"]=28,["x"]=47},[453]={["y"]=28,["x"]=48},[454]={["y"]=28,["x"]=49},[455]={["y"]=28,["x"]=50},[456]={["y"]=28,["x"]=51},[457]={["y"]=28,["x"]=52},[458]={["y"]=28,["x"]=53},[459]={["y"]=28,["x"]=54},[460]={["y"]=28,["x"]=55},[461]={["y"]=28,["x"]=56},[462]={["y"]=28,["x"]=57},[463]={["y"]=28,["x"]=58},[464]={["y"]=28,["x"]=59},[465]={["y"]=28,["x"]=60},[466]={["y"]=28,["x"]=61},[467]={["y"]=28,["x"]=62},[468]={["y"]=28,["x"]=63},[469]={["y"]=28,["x"]=64},[470]={["y"]=28,["x"]=65},[471]={["y"]=28,["x"]=66},[472]={["y"]=28,["x"]=67},[473]={["y"]=28,["x"]=68},[474]={["y"]=28,["x"]=69},[475]={["y"]=28,["x"]=70},[476]={["y"]=28,["x"]=71},[477]={["y"]=28,["x"]=72},[478]={["y"]=28,["x"]=73},[479]={["y"]=28,["x"]=74},[480]={["y"]=28,["x"]=75},[481]={["y"]=28,["x"]=76},[482]={["y"]=28,["x"]=77},[483]={["y"]=28,["x"]=78},[484]={["y"]=28,["x"]=79},[485]={["y"]=28,["x"]=80},[486]={["y"]=28,["x"]=81},[487]={["y"]=26,["x"]=0},[488]={["y"]=27,["x"]=0},[489]={["y"]=28,["x"]=0},[490]={["y"]=25,["x"]=1},[491]={["y"]=25,["x"]=2},[492]={["y"]=25,["x"]=3},[493]={["y"]=25,["x"]=4},[494]={["y"]=25,["x"]=5},[495]={["y"]=25,["x"]=6},[496]={["y"]=25,["x"]=7},[497]={["y"]=25,["x"]=8},[498]={["y"]=25,["x"]=9},[499]={["y"]=25,["x"]=10},[500]={["y"]=25,["x"]=11},[501]={["y"]=25,["x"]=12},[502]={["y"]=25,["x"]=13},[503]={["y"]=25,["x"]=14},[504]={["y"]=25,["x"]=15},[505]={["y"]=25,["x"]=16},[506]={["y"]=25,["x"]=17},[507]={["y"]=25,["x"]=18},[508]={["y"]=25,["x"]=19},[509]={["y"]=25,["x"]=20},[510]={["y"]=25,["x"]=21},[511]={["y"]=25,["x"]=22},[512]={["y"]=25,["x"]=23},[513]={["y"]=25,["x"]=24},[514]={["y"]=25,["x"]=25},[515]={["y"]=25,["x"]=26},[516]={["y"]=25,["x"]=27},[517]={["y"]=25,["x"]=28},[518]={["y"]=25,["x"]=29},[519]={["y"]=25,["x"]=30},[520]={["y"]=25,["x"]=31},[521]={["y"]=25,["x"]=32},[522]={["y"]=25,["x"]=33},[523]={["y"]=25,["x"]=34},[524]={["y"]=25,["x"]=35},[525]={["y"]=25,["x"]=36},[526]={["y"]=25,["x"]=37},[527]={["y"]=25,["x"]=38},[528]={["y"]=25,["x"]=39},[529]={["y"]=25,["x"]=40},[530]={["y"]=25,["x"]=41},[531]={["y"]=25,["x"]=42},[532]={["y"]=25,["x"]=43},[533]={["y"]=25,["x"]=44},[534]={["y"]=25,["x"]=45},[535]={["y"]=25,["x"]=46},[536]={["y"]=25,["x"]=47},[537]={["y"]=25,["x"]=48},[538]={["y"]=25,["x"]=49},[539]={["y"]=25,["x"]=50},[540]={["y"]=25,["x"]=51},[541]={["y"]=25,["x"]=52},[542]={["y"]=25,["x"]=53},[543]={["y"]=25,["x"]=54},[544]={["y"]=25,["x"]=55},[545]={["y"]=25,["x"]=56},[546]={["y"]=25,["x"]=57},[547]={["y"]=25,["x"]=58},[548]={["y"]=25,["x"]=59},[549]={["y"]=25,["x"]=60},[550]={["y"]=25,["x"]=61},[551]={["y"]=25,["x"]=62},[552]={["y"]=25,["x"]=63},[553]={["y"]=25,["x"]=64},[554]={["y"]=25,["x"]=65},[555]={["y"]=25,["x"]=66},[556]={["y"]=25,["x"]=67},[557]={["y"]=25,["x"]=68},[558]={["y"]=25,["x"]=69},[559]={["y"]=25,["x"]=70},[560]={["y"]=25,["x"]=71},[561]={["y"]=25,["x"]=72},[562]={["y"]=25,["x"]=73},[563]={["y"]=25,["x"]=74},[564]={["y"]=25,["x"]=75},[565]={["y"]=25,["x"]=76},[566]={["y"]=25,["x"]=77},[567]={["y"]=25,["x"]=78},[568]={["y"]=25,["x"]=79},[569]={["y"]=25,["x"]=80},[570]={["y"]=25,["x"]=81},[571]={["y"]=25,["x"]=0},[572]={["y"]=24,["x"]=0},[573]={["y"]=24,["x"]=1},[574]={["y"]=24,["x"]=2},[575]={["y"]=24,["x"]=3},[576]={["y"]=24,["x"]=4},[577]={["y"]=24,["x"]=5},[578]={["y"]=24,["x"]=6},[579]={["y"]=24,["x"]=7},[580]={["y"]=24,["x"]=8},[581]={["y"]=24,["x"]=9},[582]={["y"]=24,["x"]=10},[583]={["y"]=24,["x"]=11},[584]={["y"]=24,["x"]=12},[585]={["y"]=24,["x"]=13},[586]={["y"]=24,["x"]=14},[587]={["y"]=24,["x"]=15},[588]={["y"]=24,["x"]=16},[589]={["y"]=24,["x"]=17},[590]={["y"]=24,["x"]=18},[591]={["y"]=24,["x"]=19},[592]={["y"]=24,["x"]=20},[593]={["y"]=24,["x"]=21},[594]={["y"]=24,["x"]=22},[595]={["y"]=24,["x"]=23},[596]={["y"]=24,["x"]=24},[597]={["y"]=24,["x"]=25},[598]={["y"]=24,["x"]=26},[599]={["y"]=24,["x"]=27},[600]={["y"]=24,["x"]=28},[601]={["y"]=24,["x"]=29},[602]={["y"]=24,["x"]=30},[603]={["y"]=24,["x"]=31},[604]={["y"]=24,["x"]=32},[605]={["y"]=24,["x"]=33},[606]={["y"]=24,["x"]=34},[607]={["y"]=24,["x"]=35},[608]={["y"]=24,["x"]=36},[609]={["y"]=24,["x"]=37},[610]={["y"]=24,["x"]=38},[611]={["y"]=24,["x"]=39},[612]={["y"]=24,["x"]=40},[613]={["y"]=24,["x"]=41},[614]={["y"]=24,["x"]=42},[615]={["y"]=24,["x"]=43},[616]={["y"]=24,["x"]=44},[617]={["y"]=24,["x"]=45},[618]={["y"]=24,["x"]=46},[619]={["y"]=24,["x"]=47},[620]={["y"]=24,["x"]=48},[621]={["y"]=24,["x"]=49},[622]={["y"]=24,["x"]=50},[623]={["y"]=24,["x"]=51},[624]={["y"]=24,["x"]=52},[625]={["y"]=24,["x"]=53},[626]={["y"]=24,["x"]=54},[627]={["y"]=24,["x"]=55},[628]={["y"]=24,["x"]=56},[629]={["y"]=24,["x"]=57},[630]={["y"]=24,["x"]=58},[631]={["y"]=24,["x"]=59},[632]={["y"]=24,["x"]=60},[633]={["y"]=24,["x"]=61},[634]={["y"]=24,["x"]=62},[635]={["y"]=24,["x"]=63},[636]={["y"]=24,["x"]=64},[637]={["y"]=24,["x"]=65},[638]={["y"]=24,["x"]=66},[639]={["y"]=24,["x"]=67},[640]={["y"]=24,["x"]=68},[641]={["y"]=24,["x"]=69},[642]={["y"]=24,["x"]=70},[643]={["y"]=24,["x"]=71},[644]={["y"]=24,["x"]=72},[645]={["y"]=24,["x"]=73},[646]={["y"]=24,["x"]=74},[647]={["y"]=24,["x"]=75},[648]={["y"]=24,["x"]=76},[649]={["y"]=24,["x"]=77},[650]={["y"]=24,["x"]=78},[651]={["y"]=24,["x"]=79},[652]={["y"]=24,["x"]=80},[653]={["y"]=23,["x"]=80},[654]={["y"]=23,["x"]=79},[655]={["y"]=23,["x"]=78},[656]={["y"]=23,["x"]=77},[657]={["y"]=23,["x"]=76},[658]={["y"]=23,["x"]=75},[659]={["y"]=23,["x"]=74},[660]={["y"]=23,["x"]=73},[661]={["y"]=22,["x"]=75},[662]={["y"]=22,["x"]=76},[663]={["y"]=22,["x"]=77},[664]={["y"]=22,["x"]=78},[665]={["y"]=22,["x"]=79},[666]={["y"]=22,["x"]=80},[667]={["y"]=21,["x"]=80},[668]={["y"]=21,["x"]=79},[669]={["y"]=21,["x"]=78},[670]={["y"]=21,["x"]=77},[671]={["y"]=21,["x"]=76},[672]={["y"]=21,["x"]=75},[673]={["y"]=20,["x"]=76},[674]={["y"]=20,["x"]=77},[675]={["y"]=20,["x"]=78},[676]={["y"]=20,["x"]=79},[677]={["y"]=20,["x"]=80},[678]={["y"]=19,["x"]=80},[679]={["y"]=19,["x"]=79},[680]={["y"]=19,["x"]=78},[681]={["y"]=19,["x"]=77},[682]={["y"]=18,["x"]=77},[683]={["y"]=18,["x"]=78},[684]={["y"]=18,["x"]=79},[685]={["y"]=18,["x"]=80},[686]={["y"]=17,["x"]=80},[687]={["y"]=17,["x"]=79},[688]={["y"]=17,["x"]=78},[689]={["y"]=17,["x"]=77},[690]={["y"]=16,["x"]=77},[691]={["y"]=16,["x"]=78},[692]={["y"]=16,["x"]=79},[693]={["y"]=16,["x"]=80},[694]={["y"]=15,["x"]=80},[695]={["y"]=15,["x"]=79},[696]={["y"]=15,["x"]=78},[697]={["y"]=15,["x"]=77},[698]={["y"]=14,["x"]=77},[699]={["y"]=14,["x"]=78},[700]={["y"]=14,["x"]=79},[701]={["y"]=14,["x"]=80},[702]={["y"]=13,["x"]=80},[703]={["y"]=13,["x"]=79},[704]={["y"]=13,["x"]=78},[705]={["y"]=13,["x"]=77},[706]={["y"]=12,["x"]=77},[707]={["y"]=12,["x"]=78},[708]={["y"]=12,["x"]=79},[709]={["y"]=12,["x"]=80},[710]={["y"]=11,["x"]=80},[711]={["y"]=11,["x"]=79},[712]={["y"]=11,["x"]=78},[713]={["y"]=11,["x"]=77},[714]={["y"]=10,["x"]=77},[715]={["y"]=10,["x"]=78},[716]={["y"]=10,["x"]=79},[717]={["y"]=10,["x"]=80},[718]={["y"]=9,["x"]=80},[719]={["y"]=9,["x"]=79},[720]={["y"]=9,["x"]=78},[721]={["y"]=9,["x"]=77},[722]={["y"]=8,["x"]=77},[723]={["y"]=8,["x"]=78},[724]={["y"]=8,["x"]=79},[725]={["y"]=8,["x"]=80},[726]={["y"]=7,["x"]=80},[727]={["y"]=7,["x"]=79},[728]={["y"]=7,["x"]=78},[729]={["y"]=7,["x"]=77},[730]={["y"]=7,["x"]=76},[731]={["y"]=7,["x"]=75},[732]={["y"]=6,["x"]=75},[733]={["y"]=6,["x"]=76},[734]={["y"]=6,["x"]=77},[735]={["y"]=6,["x"]=78},[736]={["y"]=6,["x"]=79},[737]={["y"]=6,["x"]=80},[738]={["y"]=5,["x"]=80},[739]={["y"]=5,["x"]=79},[740]={["y"]=5,["x"]=78},[741]={["y"]=5,["x"]=77},[742]={["y"]=5,["x"]=75},[743]={["y"]=5,["x"]=76},[744]={["y"]=5,["x"]=74},[745]={["y"]=5,["x"]=73},[746]={["y"]=5,["x"]=72},[747]={["y"]=5,["x"]=71},[748]={["y"]=5,["x"]=70},[749]={["y"]=5,["x"]=69},[750]={["y"]=5,["x"]=68},[751]={["y"]=5,["x"]=67},[752]={["y"]=5,["x"]=66},[753]={["y"]=5,["x"]=65},[754]={["y"]=5,["x"]=64},[755]={["y"]=5,["x"]=63},[756]={["y"]=5,["x"]=62},[757]={["y"]=5,["x"]=61},[758]={["y"]=5,["x"]=60},[759]={["y"]=5,["x"]=59},[760]={["y"]=5,["x"]=58},[761]={["y"]=5,["x"]=57},[762]={["y"]=5,["x"]=56},[763]={["y"]=5,["x"]=55},[764]={["y"]=5,["x"]=54},[765]={["y"]=5,["x"]=53},[766]={["y"]=5,["x"]=52},[767]={["y"]=4,["x"]=52},[768]={["y"]=3,["x"]=52},[769]={["y"]=3,["x"]=53},[770]={["y"]=3,["x"]=54},[771]={["y"]=3,["x"]=55},[772]={["y"]=3,["x"]=56},[773]={["y"]=3,["x"]=57},[774]={["y"]=3,["x"]=58},[775]={["y"]=3,["x"]=59},[776]={["y"]=3,["x"]=60},[777]={["y"]=3,["x"]=61},[778]={["y"]=3,["x"]=62},[779]={["y"]=3,["x"]=63},[780]={["y"]=3,["x"]=64},[781]={["y"]=3,["x"]=65},[782]={["y"]=3,["x"]=66},[783]={["y"]=3,["x"]=67},[784]={["y"]=3,["x"]=68},[785]={["y"]=3,["x"]=69},[786]={["y"]=3,["x"]=70},[787]={["y"]=3,["x"]=71},[788]={["y"]=3,["x"]=72},[789]={["y"]=3,["x"]=73},[790]={["y"]=4,["x"]=73},[791]={["y"]=5,["x"]=51},[792]={["y"]=5,["x"]=50},[793]={["y"]=6,["x"]=50},[794]={["y"]=7,["x"]=50},[795]={["y"]=7,["x"]=49},[796]={["y"]=7,["x"]=48},[797]={["y"]=8,["x"]=48},[798]={["y"]=9,["x"]=48},[799]={["y"]=10,["x"]=48},[800]={["y"]=11,["x"]=48},[801]={["y"]=11,["x"]=47},[802]={["y"]=11,["x"]=46},[803]={["y"]=11,["x"]=45},[804]={["y"]=10,["x"]=45},[805]={["y"]=9,["x"]=45},[806]={["y"]=9,["x"]=44},[807]={["y"]=9,["x"]=43},[808]={["y"]=9,["x"]=42},[809]={["y"]=9,["x"]=41},[810]={["y"]=9,["x"]=40},[811]={["y"]=9,["x"]=39},[812]={["y"]=9,["x"]=38},[813]={["y"]=9,["x"]=37},[814]={["y"]=9,["x"]=36},[815]={["y"]=9,["x"]=35},[816]={["y"]=9,["x"]=34},[817]={["y"]=9,["x"]=33},[818]={["y"]=9,["x"]=32},[819]={["y"]=9,["x"]=31},[820]={["y"]=9,["x"]=30},[821]={["y"]=9,["x"]=29},[822]={["y"]=9,["x"]=28},[823]={["y"]=9,["x"]=27},[824]={["y"]=9,["x"]=26},[825]={["y"]=9,["x"]=25},[826]={["y"]=10,["x"]=25},[827]={["y"]=10,["x"]=24},[828]={["y"]=10,["x"]=23},[829]={["y"]=9,["x"]=23},[830]={["y"]=9,["x"]=22},[831]={["y"]=9,["x"]=21},[832]={["y"]=9,["x"]=20},[833]={["y"]=9,["x"]=19},[834]={["y"]=9,["x"]=18},[835]={["y"]=9,["x"]=17},[836]={["y"]=9,["x"]=16},[837]={["y"]=9,["x"]=15},[838]={["y"]=9,["x"]=14},[839]={["y"]=9,["x"]=13},[840]={["y"]=9,["x"]=12},[841]={["y"]=9,["x"]=11},[842]={["y"]=9,["x"]=10},[843]={["y"]=9,["x"]=9},[844]={["y"]=9,["x"]=8},[845]={["y"]=9,["x"]=7},[846]={["y"]=9,["x"]=6},[847]={["y"]=9,["x"]=5},[848]={["y"]=9,["x"]=4},[849]={["y"]=9,["x"]=3},[850]={["y"]=10,["x"]=3},[851]={["y"]=11,["x"]=3},[852]={["y"]=12,["x"]=3},[853]={["y"]=13,["x"]=3},[854]={["y"]=14,["x"]=3},[855]={["y"]=15,["x"]=3},[856]={["y"]=16,["x"]=3},[857]={["y"]=17,["x"]=3},[858]={["y"]=18,["x"]=3},[859]={["y"]=19,["x"]=3},[860]={["y"]=19,["x"]=4},[861]={["y"]=19,["x"]=5},[862]={["y"]=19,["x"]=6},[863]={["y"]=19,["x"]=7},[864]={["y"]=19,["x"]=8},[865]={["y"]=19,["x"]=9},[866]={["y"]=19,["x"]=10},[867]={["y"]=19,["x"]=11},[868]={["y"]=19,["x"]=12},[869]={["y"]=19,["x"]=13},[870]={["y"]=19,["x"]=14},[871]={["y"]=19,["x"]=15},[872]={["y"]=19,["x"]=16},[873]={["y"]=19,["x"]=17},[874]={["y"]=19,["x"]=18},[875]={["y"]=19,["x"]=19},[876]={["y"]=19,["x"]=20},[877]={["y"]=19,["x"]=21},[878]={["y"]=19,["x"]=22},[879]={["y"]=19,["x"]=23},[880]={["y"]=18,["x"]=23},[881]={["y"]=18,["x"]=24},[882]={["y"]=18,["x"]=25},[883]={["y"]=19,["x"]=25},[884]={["y"]=19,["x"]=26},[885]={["y"]=19,["x"]=27},[886]={["y"]=19,["x"]=28},[887]={["y"]=19,["x"]=29},[888]={["y"]=19,["x"]=30},[889]={["y"]=19,["x"]=31},[890]={["y"]=19,["x"]=32},[891]={["y"]=19,["x"]=33},[892]={["y"]=19,["x"]=34},[893]={["y"]=19,["x"]=35},[894]={["y"]=19,["x"]=36},[895]={["y"]=19,["x"]=37},[896]={["y"]=19,["x"]=38},[897]={["y"]=19,["x"]=39},[898]={["y"]=19,["x"]=40},[899]={["y"]=19,["x"]=41},[900]={["y"]=19,["x"]=42},[901]={["y"]=19,["x"]=43},[902]={["y"]=19,["x"]=44},[903]={["y"]=19,["x"]=45},[904]={["y"]=18,["x"]=45},[905]={["y"]=17,["x"]=45},[906]={["y"]=17,["x"]=46},[907]={["y"]=17,["x"]=47},[908]={["y"]=17,["x"]=48},[909]={["y"]=18,["x"]=48},[910]={["y"]=19,["x"]=48},[911]={["y"]=20,["x"]=48},[912]={["y"]=21,["x"]=48},[913]={["y"]=21,["x"]=49},[914]={["y"]=21,["x"]=50},[915]={["y"]=22,["x"]=50},[916]={["y"]=23,["x"]=50},[917]={["y"]=23,["x"]=51},[918]={["y"]=23,["x"]=52},[919]={["y"]=23,["x"]=53},[920]={["y"]=23,["x"]=54},[921]={["y"]=23,["x"]=55},[922]={["y"]=23,["x"]=56},[923]={["y"]=23,["x"]=57},[924]={["y"]=23,["x"]=58},[925]={["y"]=23,["x"]=59},[926]={["y"]=23,["x"]=60},[927]={["y"]=23,["x"]=61},[928]={["y"]=23,["x"]=62},[929]={["y"]=23,["x"]=63},[930]={["y"]=23,["x"]=64},[931]={["y"]=23,["x"]=65},[932]={["y"]=23,["x"]=66},[933]={["y"]=23,["x"]=67},[934]={["y"]=23,["x"]=68},[935]={["y"]=23,["x"]=70},[936]={["y"]=23,["x"]=71},[937]={["y"]=23,["x"]=72},[938]={["y"]=23,["x"]=69},[939]={["y"]=19,["x"]=69},[940]={["y"]=19,["x"]=68},[941]={["y"]=19,["x"]=67},[942]={["y"]=19,["x"]=66},[943]={["y"]=19,["x"]=57},[944]={["y"]=19,["x"]=56},[945]={["y"]=19,["x"]=55},[946]={["y"]=19,["x"]=54},[947]={["y"]=20,["x"]=49},[948]={["y"]=22,["x"]=51},[949]={["y"]=8,["x"]=76},[950]={["y"]=6,["x"]=74},[951]={["y"]=9,["x"]=69},[952]={["y"]=9,["x"]=68},[953]={["y"]=9,["x"]=67},[954]={["y"]=9,["x"]=66},[955]={["y"]=9,["x"]=57},[956]={["y"]=9,["x"]=56},[957]={["y"]=9,["x"]=55},[958]={["y"]=9,["x"]=54},[959]={["y"]=8,["x"]=49},[960]={["y"]=6,["x"]=51},[961]={["y"]=4,["x"]=53},[962]={["y"]=4,["x"]=54},[963]={["y"]=4,["x"]=55},[964]={["y"]=4,["x"]=56},[965]={["y"]=4,["x"]=57},[966]={["y"]=4,["x"]=58},[967]={["y"]=4,["x"]=59},[968]={["y"]=4,["x"]=60},[969]={["y"]=4,["x"]=61},[970]={["y"]=4,["x"]=62},[971]={["y"]=4,["x"]=63},[972]={["y"]=4,["x"]=64},[973]={["y"]=4,["x"]=65},[974]={["y"]=4,["x"]=66},[975]={["y"]=4,["x"]=67},[976]={["y"]=4,["x"]=68},[977]={["y"]=4,["x"]=69},[978]={["y"]=4,["x"]=70},[979]={["y"]=4,["x"]=71},[980]={["y"]=4,["x"]=72},[981]={["y"]=18,["x"]=43},[982]={["y"]=18,["x"]=41},[983]={["y"]=18,["x"]=39},[984]={["y"]=18,["x"]=37},[985]={["y"]=18,["x"]=35},[986]={["y"]=18,["x"]=33},[987]={["y"]=18,["x"]=31},[988]={["y"]=18,["x"]=29},[989]={["y"]=18,["x"]=27},[990]={["y"]=18,["x"]=22},[991]={["y"]=18,["x"]=21},[992]={["y"]=18,["x"]=5},[993]={["y"]=18,["x"]=4},[994]={["y"]=17,["x"]=4},[995]={["y"]=11,["x"]=4},[996]={["y"]=10,["x"]=4},[997]={["y"]=10,["x"]=5},[998]={["y"]=10,["x"]=21},[999]={["y"]=10,["x"]=22},[1000]={["y"]=10,["x"]=27},[1001]={["y"]=10,["x"]=29},[1002]={["y"]=10,["x"]=31},[1003]={["y"]=10,["x"]=33},[1004]={["y"]=10,["x"]=35},[1005]={["y"]=10,["x"]=37},[1006]={["y"]=10,["x"]=39},[1007]={["y"]=10,["x"]=41},[1008]={["y"]=10,["x"]=43},[1009]={["y"]=3,["x"]=51},[1010]={["y"]=3,["x"]=50},[1011]={["y"]=3,["x"]=49},[1012]={["y"]=3,["x"]=48},[1013]={["y"]=3,["x"]=47},[1014]={["y"]=0,["x"]=0},[1015]={["y"]=1,["x"]=0},[1016]={["y"]=2,["x"]=0},[1017]={["y"]=9,["x"]=0},[1018]={["y"]=9,["x"]=1},[1019]={["y"]=9,["x"]=2},[1020]={["y"]=10,["x"]=2},[1021]={["y"]=10,["x"]=1},[1022]={["y"]=10,["x"]=0},[1023]={["y"]=11,["x"]=0},[1024]={["y"]=11,["x"]=1},[1025]={["y"]=11,["x"]=2},[1026]={["y"]=12,["x"]=2},[1027]={["y"]=12,["x"]=1},[1028]={["y"]=12,["x"]=0},[1029]={["y"]=13,["x"]=0},[1030]={["y"]=13,["x"]=1},[1031]={["y"]=13,["x"]=2},[1032]={["y"]=14,["x"]=2},[1033]={["y"]=14,["x"]=1},[1034]={["y"]=14,["x"]=0},[1035]={["y"]=15,["x"]=0},[1036]={["y"]=15,["x"]=1},[1037]={["y"]=15,["x"]=2},[1038]={["y"]=16,["x"]=2},[1039]={["y"]=16,["x"]=1},[1040]={["y"]=16,["x"]=0},[1041]={["y"]=17,["x"]=0},[1042]={["y"]=17,["x"]=1},[1043]={["y"]=17,["x"]=2},[1044]={["y"]=18,["x"]=2},[1045]={["y"]=18,["x"]=1},[1046]={["y"]=18,["x"]=0},[1047]={["y"]=19,["x"]=0},[1048]={["y"]=19,["x"]=1},[1049]={["y"]=19,["x"]=2},[1050]={["y"]=20,["x"]=0},[1051]={["y"]=21,["x"]=0},[1052]={["y"]=22,["x"]=0},[1053]={["y"]=23,["x"]=0},[1054]={["y"]=23,["x"]=1},[1055]={["y"]=22,["x"]=1},[1056]={["y"]=20,["x"]=1},[1057]={["y"]=21,["x"]=1},[1058]={["y"]=20,["x"]=2},[1059]={["y"]=21,["x"]=2},[1060]={["y"]=22,["x"]=2},[1061]={["y"]=23,["x"]=2},[1062]={["y"]=23,["x"]=3},[1063]={["y"]=22,["x"]=3},[1064]={["y"]=21,["x"]=3},[1065]={["y"]=20,["x"]=3},[1066]={["y"]=20,["x"]=4},[1067]={["y"]=21,["x"]=4},[1068]={["y"]=22,["x"]=4},[1069]={["y"]=23,["x"]=4},[1070]={["y"]=23,["x"]=5},[1071]={["y"]=22,["x"]=5},[1072]={["y"]=21,["x"]=5},[1073]={["y"]=20,["x"]=5},[1074]={["y"]=20,["x"]=6},[1075]={["y"]=21,["x"]=6},[1076]={["y"]=22,["x"]=6},[1077]={["y"]=23,["x"]=6},[1078]={["y"]=23,["x"]=7},[1079]={["y"]=22,["x"]=7},[1080]={["y"]=21,["x"]=7},[1081]={["y"]=20,["x"]=7},[1082]={["y"]=20,["x"]=8},[1083]={["y"]=21,["x"]=8},[1084]={["y"]=22,["x"]=8},[1085]={["y"]=23,["x"]=8},[1086]={["y"]=23,["x"]=9},[1087]={["y"]=22,["x"]=9},[1088]={["y"]=21,["x"]=9},[1089]={["y"]=20,["x"]=9},[1090]={["y"]=20,["x"]=10},[1091]={["y"]=21,["x"]=10},[1092]={["y"]=22,["x"]=10},[1093]={["y"]=23,["x"]=10},[1094]={["y"]=23,["x"]=11},[1095]={["y"]=22,["x"]=11},[1096]={["y"]=21,["x"]=11},[1097]={["y"]=20,["x"]=11},[1098]={["y"]=20,["x"]=12},[1099]={["y"]=21,["x"]=12},[1100]={["y"]=22,["x"]=12},[1101]={["y"]=23,["x"]=12},[1102]={["y"]=23,["x"]=13},[1103]={["y"]=22,["x"]=13},[1104]={["y"]=21,["x"]=13},[1105]={["y"]=20,["x"]=13},[1106]={["y"]=20,["x"]=14},[1107]={["y"]=21,["x"]=14},[1108]={["y"]=22,["x"]=14},[1109]={["y"]=23,["x"]=14},[1110]={["y"]=23,["x"]=15},[1111]={["y"]=22,["x"]=15},[1112]={["y"]=21,["x"]=15},[1113]={["y"]=20,["x"]=15},[1114]={["y"]=20,["x"]=16},[1115]={["y"]=21,["x"]=16},[1116]={["y"]=22,["x"]=16},[1117]={["y"]=23,["x"]=16},[1118]={["y"]=23,["x"]=17},[1119]={["y"]=22,["x"]=17},[1120]={["y"]=21,["x"]=17},[1121]={["y"]=20,["x"]=17},[1122]={["y"]=20,["x"]=18},[1123]={["y"]=21,["x"]=18},[1124]={["y"]=22,["x"]=18},[1125]={["y"]=23,["x"]=18},[1126]={["y"]=23,["x"]=19},[1127]={["y"]=22,["x"]=19},[1128]={["y"]=21,["x"]=19},[1129]={["y"]=21,["x"]=19},[1130]={["y"]=20,["x"]=19},[1131]={["y"]=20,["x"]=20},[1132]={["y"]=21,["x"]=20},[1133]={["y"]=22,["x"]=20},[1134]={["y"]=23,["x"]=20},[1135]={["y"]=23,["x"]=21},[1136]={["y"]=22,["x"]=21},[1137]={["y"]=21,["x"]=21},[1138]={["y"]=20,["x"]=21},[1139]={["y"]=20,["x"]=22},[1140]={["y"]=21,["x"]=22},[1141]={["y"]=22,["x"]=22},[1142]={["y"]=23,["x"]=22},[1143]={["y"]=23,["x"]=23},[1144]={["y"]=22,["x"]=23},[1145]={["y"]=21,["x"]=23},[1146]={["y"]=20,["x"]=23},[1147]={["y"]=19,["x"]=24},[1148]={["y"]=20,["x"]=24},[1149]={["y"]=21,["x"]=24},[1150]={["y"]=22,["x"]=24},[1151]={["y"]=23,["x"]=24},[1152]={["y"]=23,["x"]=25},[1153]={["y"]=22,["x"]=25},[1154]={["y"]=21,["x"]=25},[1155]={["y"]=20,["x"]=25},[1156]={["y"]=20,["x"]=26},[1157]={["y"]=21,["x"]=26},[1158]={["y"]=22,["x"]=26},[1159]={["y"]=23,["x"]=26},[1160]={["y"]=23,["x"]=27},[1161]={["y"]=22,["x"]=27},[1162]={["y"]=21,["x"]=27},[1163]={["y"]=20,["x"]=27},[1164]={["y"]=20,["x"]=28},[1165]={["y"]=21,["x"]=28},[1166]={["y"]=22,["x"]=28},[1167]={["y"]=23,["x"]=28},[1168]={["y"]=23,["x"]=29},[1169]={["y"]=22,["x"]=29},[1170]={["y"]=21,["x"]=29},[1171]={["y"]=20,["x"]=29},[1172]={["y"]=20,["x"]=30},[1173]={["y"]=21,["x"]=30},[1174]={["y"]=22,["x"]=30},[1175]={["y"]=23,["x"]=30},[1176]={["y"]=23,["x"]=31},[1177]={["y"]=22,["x"]=31},[1178]={["y"]=21,["x"]=31},[1179]={["y"]=20,["x"]=31},[1180]={["y"]=20,["x"]=32},[1181]={["y"]=21,["x"]=32},[1182]={["y"]=22,["x"]=32},[1183]={["y"]=23,["x"]=32},[1184]={["y"]=23,["x"]=33},[1185]={["y"]=22,["x"]=33},[1186]={["y"]=21,["x"]=33},[1187]={["y"]=20,["x"]=33},[1188]={["y"]=20,["x"]=34},[1189]={["y"]=21,["x"]=34},[1190]={["y"]=22,["x"]=34},[1191]={["y"]=23,["x"]=34},[1192]={["y"]=23,["x"]=35},[1193]={["y"]=22,["x"]=35},[1194]={["y"]=21,["x"]=35},[1195]={["y"]=20,["x"]=35},[1196]={["y"]=20,["x"]=36},[1197]={["y"]=21,["x"]=36},[1198]={["y"]=22,["x"]=36},[1199]={["y"]=23,["x"]=36},[1200]={["y"]=23,["x"]=37},[1201]={["y"]=22,["x"]=37},[1202]={["y"]=21,["x"]=37},[1203]={["y"]=20,["x"]=37},[1204]={["y"]=20,["x"]=38},[1205]={["y"]=21,["x"]=38},[1206]={["y"]=22,["x"]=38},[1207]={["y"]=23,["x"]=38},[1208]={["y"]=23,["x"]=39},[1209]={["y"]=22,["x"]=39},[1210]={["y"]=21,["x"]=39},[1211]={["y"]=20,["x"]=39},[1212]={["y"]=20,["x"]=40},[1213]={["y"]=21,["x"]=40},[1214]={["y"]=22,["x"]=40},[1215]={["y"]=23,["x"]=40},[1216]={["y"]=23,["x"]=41},[1217]={["y"]=22,["x"]=41},[1218]={["y"]=21,["x"]=41},[1219]={["y"]=20,["x"]=41},[1220]={["y"]=20,["x"]=42},[1221]={["y"]=21,["x"]=42},[1222]={["y"]=22,["x"]=42},[1223]={["y"]=23,["x"]=42},[1224]={["y"]=23,["x"]=43},[1225]={["y"]=22,["x"]=43},[1226]={["y"]=21,["x"]=43},[1227]={["y"]=20,["x"]=43},[1228]={["y"]=20,["x"]=44},[1229]={["y"]=21,["x"]=44},[1230]={["y"]=22,["x"]=44},[1231]={["y"]=23,["x"]=44},[1232]={["y"]=23,["x"]=45},[1233]={["y"]=22,["x"]=45},[1234]={["y"]=21,["x"]=45},[1235]={["y"]=20,["x"]=45},[1236]={["y"]=18,["x"]=46},[1237]={["y"]=18,["x"]=47},[1238]={["y"]=19,["x"]=47},[1239]={["y"]=19,["x"]=46},[1240]={["y"]=20,["x"]=46},[1241]={["y"]=20,["x"]=47},[1242]={["y"]=21,["x"]=47},[1243]={["y"]=21,["x"]=46},[1244]={["y"]=22,["x"]=46},[1245]={["y"]=22,["x"]=47},[1246]={["y"]=22,["x"]=48},[1247]={["y"]=22,["x"]=49},[1248]={["y"]=23,["x"]=49},[1249]={["y"]=23,["x"]=48},[1250]={["y"]=23,["x"]=47},[1251]={["y"]=23,["x"]=46},[1252]={["y"]=4,["x"]=74},[1253]={["y"]=3,["x"]=74},[1254]={["y"]=3,["x"]=75},[1255]={["y"]=4,["x"]=75},[1256]={["y"]=4,["x"]=76},[1257]={["y"]=3,["x"]=76},[1258]={["y"]=3,["x"]=77},[1259]={["y"]=4,["x"]=77},[1260]={["y"]=4,["x"]=78},[1261]={["y"]=3,["x"]=78},[1262]={["y"]=3,["x"]=79},[1263]={["y"]=4,["x"]=80},[1264]={["y"]=3,["x"]=80},[1265]={["y"]=4,["x"]=79},[1266]={["y"]=4,["x"]=51},[1267]={["y"]=4,["x"]=50},[1268]={["y"]=4,["x"]=49},[1269]={["y"]=6,["x"]=49},[1270]={["y"]=5,["x"]=49},[1271]={["y"]=6,["x"]=48},[1272]={["y"]=5,["x"]=48},[1273]={["y"]=4,["x"]=48},[1274]={["y"]=4,["x"]=47},[1275]={["y"]=5,["x"]=47},[1276]={["y"]=6,["x"]=47},[1277]={["y"]=7,["x"]=47},[1278]={["y"]=8,["x"]=47},[1279]={["y"]=10,["x"]=47},[1280]={["y"]=9,["x"]=47},[1281]={["y"]=9,["x"]=46},[1282]={["y"]=10,["x"]=46},[1283]={["y"]=8,["x"]=46},[1284]={["y"]=7,["x"]=46},[1285]={["y"]=6,["x"]=46},[1286]={["y"]=5,["x"]=46},[1287]={["y"]=4,["x"]=46},[1288]={["y"]=3,["x"]=46},[1289]={["y"]=3,["x"]=45},[1290]={["y"]=4,["x"]=45},[1291]={["y"]=5,["x"]=45},[1292]={["y"]=6,["x"]=45},[1293]={["y"]=7,["x"]=45},[1294]={["y"]=8,["x"]=45},[1295]={["y"]=8,["x"]=44},[1296]={["y"]=7,["x"]=44},[1297]={["y"]=6,["x"]=44},[1298]={["y"]=5,["x"]=44},[1299]={["y"]=4,["x"]=44},[1300]={["y"]=3,["x"]=44},[1301]={["y"]=3,["x"]=43},[1302]={["y"]=4,["x"]=43},[1303]={["y"]=5,["x"]=43},[1304]={["y"]=6,["x"]=43},[1305]={["y"]=7,["x"]=43},[1306]={["y"]=8,["x"]=43},[1307]={["y"]=8,["x"]=42},[1308]={["y"]=7,["x"]=42},[1309]={["y"]=6,["x"]=42},[1310]={["y"]=5,["x"]=42},[1311]={["y"]=4,["x"]=42},[1312]={["y"]=3,["x"]=41},[1313]={["y"]=3,["x"]=42},[1314]={["y"]=4,["x"]=41},[1315]={["y"]=5,["x"]=41},[1316]={["y"]=6,["x"]=41},[1317]={["y"]=7,["x"]=41},[1318]={["y"]=8,["x"]=41},[1319]={["y"]=8,["x"]=40},[1320]={["y"]=7,["x"]=40},[1321]={["y"]=6,["x"]=40},[1322]={["y"]=5,["x"]=40},[1323]={["y"]=4,["x"]=40},[1324]={["y"]=3,["x"]=40},[1325]={["y"]=3,["x"]=39},[1326]={["y"]=4,["x"]=39},[1327]={["y"]=5,["x"]=39},[1328]={["y"]=6,["x"]=39},[1329]={["y"]=7,["x"]=39},[1330]={["y"]=8,["x"]=39},[1331]={["y"]=8,["x"]=38},[1332]={["y"]=7,["x"]=38},[1333]={["y"]=6,["x"]=38},[1334]={["y"]=5,["x"]=38},[1335]={["y"]=4,["x"]=38},[1336]={["y"]=3,["x"]=38},[1337]={["y"]=3,["x"]=37},[1338]={["y"]=4,["x"]=37},[1339]={["y"]=5,["x"]=37},[1340]={["y"]=6,["x"]=37},[1341]={["y"]=7,["x"]=37},[1342]={["y"]=8,["x"]=37},[1343]={["y"]=8,["x"]=36},[1344]={["y"]=7,["x"]=36},[1345]={["y"]=6,["x"]=36},[1346]={["y"]=5,["x"]=36},[1347]={["y"]=4,["x"]=36},[1348]={["y"]=3,["x"]=36},[1349]={["y"]=3,["x"]=35},[1350]={["y"]=4,["x"]=35},[1351]={["y"]=5,["x"]=35},[1352]={["y"]=6,["x"]=35},[1353]={["y"]=7,["x"]=35},[1354]={["y"]=8,["x"]=35},[1355]={["y"]=8,["x"]=34},[1356]={["y"]=7,["x"]=34},[1357]={["y"]=6,["x"]=34},[1358]={["y"]=5,["x"]=34},[1359]={["y"]=4,["x"]=34},[1360]={["y"]=3,["x"]=34},[1361]={["y"]=3,["x"]=33},[1362]={["y"]=4,["x"]=33},[1363]={["y"]=5,["x"]=33},[1364]={["y"]=6,["x"]=33},[1365]={["y"]=7,["x"]=33},[1366]={["y"]=8,["x"]=33},[1367]={["y"]=8,["x"]=32},[1368]={["y"]=7,["x"]=32},[1369]={["y"]=6,["x"]=32},[1370]={["y"]=5,["x"]=32},[1371]={["y"]=4,["x"]=32},[1372]={["y"]=3,["x"]=32},[1373]={["y"]=3,["x"]=31},[1374]={["y"]=4,["x"]=31},[1375]={["y"]=5,["x"]=31},[1376]={["y"]=6,["x"]=31},[1377]={["y"]=7,["x"]=31},[1378]={["y"]=8,["x"]=31},[1379]={["y"]=8,["x"]=30},[1380]={["y"]=7,["x"]=30},[1381]={["y"]=6,["x"]=30},[1382]={["y"]=5,["x"]=30},[1383]={["y"]=4,["x"]=30},[1384]={["y"]=3,["x"]=30},[1385]={["y"]=3,["x"]=29},[1386]={["y"]=4,["x"]=29},[1387]={["y"]=5,["x"]=29},[1388]={["y"]=6,["x"]=29},[1389]={["y"]=7,["x"]=29},[1390]={["y"]=8,["x"]=29},[1391]={["y"]=8,["x"]=28},[1392]={["y"]=7,["x"]=28},[1393]={["y"]=6,["x"]=28},[1394]={["y"]=5,["x"]=28},[1395]={["y"]=4,["x"]=28},[1396]={["y"]=3,["x"]=28},[1397]={["y"]=3,["x"]=27},[1398]={["y"]=4,["x"]=27},[1399]={["y"]=5,["x"]=27},[1400]={["y"]=6,["x"]=27},[1401]={["y"]=7,["x"]=27},[1402]={["y"]=8,["x"]=27},[1403]={["y"]=8,["x"]=26},[1404]={["y"]=8,["x"]=25},[1405]={["y"]=8,["x"]=24},[1406]={["y"]=9,["x"]=24},[1407]={["y"]=7,["x"]=24},[1408]={["y"]=6,["x"]=24},[1409]={["y"]=5,["x"]=24},[1410]={["y"]=4,["x"]=24},[1411]={["y"]=3,["x"]=24},[1412]={["y"]=3,["x"]=25},[1413]={["y"]=4,["x"]=25},[1414]={["y"]=5,["x"]=25},[1415]={["y"]=6,["x"]=25},[1416]={["y"]=7,["x"]=25},[1417]={["y"]=7,["x"]=26},[1418]={["y"]=5,["x"]=26},[1419]={["y"]=4,["x"]=26},[1420]={["y"]=3,["x"]=26},[1421]={["y"]=6,["x"]=26},[1422]={["y"]=8,["x"]=23},[1423]={["y"]=7,["x"]=23},[1424]={["y"]=6,["x"]=23},[1425]={["y"]=5,["x"]=23},[1426]={["y"]=4,["x"]=23},[1427]={["y"]=3,["x"]=23},[1428]={["y"]=3,["x"]=22},[1429]={["y"]=4,["x"]=22},[1430]={["y"]=5,["x"]=22},[1431]={["y"]=6,["x"]=22},[1432]={["y"]=7,["x"]=22},[1433]={["y"]=8,["x"]=22},[1434]={["y"]=8,["x"]=21},[1435]={["y"]=7,["x"]=21},[1436]={["y"]=5,["x"]=21},[1437]={["y"]=4,["x"]=21},[1438]={["y"]=3,["x"]=21},[1439]={["y"]=6,["x"]=21},[1440]={["y"]=7,["x"]=20},[1441]={["y"]=7,["x"]=20},[1442]={["y"]=8,["x"]=20},[1443]={["y"]=6,["x"]=20},[1444]={["y"]=5,["x"]=20},[1445]={["y"]=4,["x"]=20},[1446]={["y"]=3,["x"]=20},[1447]={["y"]=3,["x"]=19},[1448]={["y"]=4,["x"]=19},[1449]={["y"]=5,["x"]=19},[1450]={["y"]=6,["x"]=19},[1451]={["y"]=7,["x"]=19},[1452]={["y"]=8,["x"]=19},[1453]={["y"]=8,["x"]=18},[1454]={["y"]=7,["x"]=18},[1455]={["y"]=6,["x"]=18},[1456]={["y"]=5,["x"]=18},[1457]={["y"]=4,["x"]=18},[1458]={["y"]=3,["x"]=18},[1459]={["y"]=3,["x"]=17},[1460]={["y"]=4,["x"]=17},[1461]={["y"]=5,["x"]=17},[1462]={["y"]=6,["x"]=17},[1463]={["y"]=7,["x"]=17},[1464]={["y"]=8,["x"]=17},[1465]={["y"]=8,["x"]=16},[1466]={["y"]=7,["x"]=16},[1467]={["y"]=6,["x"]=16},[1468]={["y"]=5,["x"]=16},[1469]={["y"]=4,["x"]=16},[1470]={["y"]=3,["x"]=16},[1471]={["y"]=3,["x"]=15},[1472]={["y"]=4,["x"]=15},[1473]={["y"]=5,["x"]=15},[1474]={["y"]=6,["x"]=15},[1475]={["y"]=7,["x"]=15},[1476]={["y"]=8,["x"]=15},[1477]={["y"]=8,["x"]=14},[1478]={["y"]=7,["x"]=14},[1479]={["y"]=6,["x"]=14},[1480]={["y"]=5,["x"]=14},[1481]={["y"]=4,["x"]=14},[1482]={["y"]=3,["x"]=14},[1483]={["y"]=3,["x"]=13},[1484]={["y"]=4,["x"]=13},[1485]={["y"]=5,["x"]=13},[1486]={["y"]=6,["x"]=13},[1487]={["y"]=7,["x"]=13},[1488]={["y"]=8,["x"]=13},[1489]={["y"]=8,["x"]=12},[1490]={["y"]=7,["x"]=12},[1491]={["y"]=6,["x"]=12},[1492]={["y"]=5,["x"]=12},[1493]={["y"]=4,["x"]=12},[1494]={["y"]=3,["x"]=12},[1495]={["y"]=3,["x"]=11},[1496]={["y"]=4,["x"]=11},[1497]={["y"]=5,["x"]=11},[1498]={["y"]=6,["x"]=11},[1499]={["y"]=7,["x"]=11},[1500]={["y"]=8,["x"]=11},[1501]={["y"]=8,["x"]=10},[1502]={["y"]=7,["x"]=10},[1503]={["y"]=6,["x"]=10},[1504]={["y"]=5,["x"]=10},[1505]={["y"]=4,["x"]=10},[1506]={["y"]=3,["x"]=10},[1507]={["y"]=3,["x"]=9},[1508]={["y"]=4,["x"]=9},[1509]={["y"]=5,["x"]=9},[1510]={["y"]=6,["x"]=9},[1511]={["y"]=7,["x"]=9},[1512]={["y"]=8,["x"]=9},[1513]={["y"]=8,["x"]=8},[1514]={["y"]=7,["x"]=8},[1515]={["y"]=6,["x"]=8},[1516]={["y"]=5,["x"]=8},[1517]={["y"]=4,["x"]=8},[1518]={["y"]=3,["x"]=8},[1519]={["y"]=3,["x"]=7},[1520]={["y"]=4,["x"]=7},[1521]={["y"]=5,["x"]=7},[1522]={["y"]=6,["x"]=7},[1523]={["y"]=7,["x"]=7},[1524]={["y"]=8,["x"]=7},[1525]={["y"]=8,["x"]=6},[1526]={["y"]=7,["x"]=6},[1527]={["y"]=6,["x"]=6},[1528]={["y"]=5,["x"]=6},[1529]={["y"]=4,["x"]=6},[1530]={["y"]=3,["x"]=6},[1531]={["y"]=3,["x"]=5},[1532]={["y"]=4,["x"]=5},[1533]={["y"]=5,["x"]=5},[1534]={["y"]=6,["x"]=5},[1535]={["y"]=7,["x"]=5},[1536]={["y"]=8,["x"]=5},[1537]={["y"]=8,["x"]=4},[1538]={["y"]=7,["x"]=4},[1539]={["y"]=6,["x"]=4},[1540]={["y"]=5,["x"]=4},[1541]={["y"]=4,["x"]=4},[1542]={["y"]=3,["x"]=4},[1543]={["y"]=3,["x"]=3},[1544]={["y"]=4,["x"]=3},[1545]={["y"]=5,["x"]=3},[1546]={["y"]=6,["x"]=3},[1547]={["y"]=7,["x"]=3},[1548]={["y"]=8,["x"]=3},[1549]={["y"]=8,["x"]=2},[1550]={["y"]=7,["x"]=2},[1551]={["y"]=6,["x"]=2},[1552]={["y"]=5,["x"]=2},[1553]={["y"]=4,["x"]=2},[1554]={["y"]=3,["x"]=2},[1555]={["y"]=3,["x"]=1},[1556]={["y"]=4,["x"]=1},[1557]={["y"]=5,["x"]=1},[1558]={["y"]=7,["x"]=1},[1559]={["y"]=8,["x"]=1},[1560]={["y"]=6,["x"]=1},[1561]={["y"]=8,["x"]=0},[1562]={["y"]=7,["x"]=0},[1563]={["y"]=6,["x"]=0},[1564]={["y"]=5,["x"]=0},[1565]={["y"]=4,["x"]=0},[1566]={["y"]=3,["x"]=0}}')
    self.selected_unit = nil
    self.target_unit = nil

    -- units and animations
    self.player_red_mana = 0
    self.player_green_mana = 0
    self.player_blue_mana = 0
    self.enemy_red_mana = 0
    self.enemy_green_mana = 0
    self.enemy_blue_mana = 0

    self.units = {}
    table.insert(self.units, P1Unit(8,13))
    table.insert(self.units, P2Unit(8,15))
    table.insert(self.units, U1Unit(7,13))
    table.insert(self.units, U2Unit(7,15))
    table.insert(self.units, E2Unit(18,14))
    table.insert(self.units, E4Unit(19,13))
    table.insert(self.units, E5Unit(19,15))
    table.insert(self.units, E3Unit(28,10))
    table.insert(self.units, E4Unit(30,10))
    table.insert(self.units, E5Unit(32,10))
    table.insert(self.units, E4Unit(34,10))
    table.insert(self.units, E3Unit(36,10))
    table.insert(self.units, E4Unit(38,10))
    table.insert(self.units, E5Unit(40,10))
    table.insert(self.units, E4Unit(42,10))
    table.insert(self.units, U3Unit(28,17))
    table.insert(self.units, U2Unit(30,17))
    table.insert(self.units, U1Unit(32,17))
    table.insert(self.units, U2Unit(34,17))
    table.insert(self.units, U3Unit(36,17))
    table.insert(self.units, U2Unit(38,17))
    table.insert(self.units, U1Unit(40,17))
    table.insert(self.units, U2Unit(42,17))
    table.insert(self.units, U3Unit(28,18))
    table.insert(self.units, U2Unit(30,18))
    table.insert(self.units, U1Unit(32,18))
    table.insert(self.units, U2Unit(34,18))
    table.insert(self.units, U3Unit(36,18))
    table.insert(self.units, U2Unit(38,18))
    table.insert(self.units, U1Unit(40,18))
    table.insert(self.units, U2Unit(42,18))
    table.insert(self.units, E1Unit(68,14))
end

-- CALLBACKS

function SRPGLayer:draw()
    camera:set()

    local tile_width_px = constants.pixel_tile_width * constants.pixel_integer_scale
    local tile_height_px = constants.pixel_tile_height * constants.pixel_integer_scale

    -- bottom: draw the map
    love.graphics.setColor(1, 1, 1, 1)
    love.graphics.draw(self.map_img, 0, 0, 0, 4, 4)

    -- in selection mode, gray out areas that cannot be targeted
    if self.active_mode == 'selection' then
        for y=0, self.tile_height_count, 1 do
            for x=0, self.tile_width_count, 1 do
                if lume.any(self.allowed_tiles, function(t) return t.x == x and t.y == y end) == false then
                    local restricted_tile_x = x_for_tile(x)
                    local restricted_tile_y = y_for_tile(y)
                    love.graphics.setColor(0, 0, 0, 0.5)
                    love.graphics.rectangle('fill', restricted_tile_x, restricted_tile_y, tile_width_px, tile_height_px)
                end
            end
        end
    end

    -- middle: other entities
    love.graphics.setColor(1, 1, 1, 1)
    lume.each(self.units, "draw")

    -- top: draw the cursor
    if self.active_mode ~= 'animation_wait' then
        local movespeed = constants.cursor_move_speed
        if self.cursor_is_turbo then
            movespeed = constants.cursor_turbo_speed
        end
        local cursor_x = x_for_tile(self.cursor_tile_x)
        local cursor_y = y_for_tile(self.cursor_tile_y)
        local cursor_proj_x = x_for_tile(self.cursor_tile_target_x)
        local cursor_proj_y = y_for_tile(self.cursor_tile_target_y)
        if cursor_x ~= cursor_proj_x or cursor_y ~= cursor_proj_y then
            local interpolation = self.cursor_tile_anim_accumulator / movespeed
            cursor_x = lume.lerp(cursor_x, cursor_proj_x, interpolation)
            cursor_y = lume.lerp(cursor_y, cursor_proj_y, interpolation)
        end
        local cursor_draw_x = cursor_x + (3*4)
        local cursor_draw_y = cursor_y - (12*4)
        love.graphics.draw(self.cursor_img, cursor_draw_x, cursor_draw_y, 0, 4, 4)
    end
    
    camera:unset()
end

function SRPGLayer:update(dt)
    if self.paused == true then
        return
    end
    if self.game_ended == true then
        return
    end
    if self.hover_ui == nil and not layer_manager:topmost():is(TransitionLayer) then
        self.hover_ui = HoverUILayer()
        layer_manager:prepend(self.hover_ui)
        self:populate_hover_ui()
    end

    self.units = lume.filter(self.units, function(u) return u.purge == false end)
    local player_units = lume.filter(self.units, function(u) return u.user_controlled == true end)
    local enemy_units = lume.filter(self.units, function(u) return u.user_controlled == false end)
    if #player_units <= 0 then
        self.game_ended = true
        log(lume.format("[{1}] game over (all friendly units dead)", { self.layer_name }))
        if self.hover_ui ~= nil then
            layer_manager:remove_first()
        end
        local win_layer = WinLayer()
        layer_manager:transition(self, win_layer)
        return
    end
    if #enemy_units <= 0 then
        self.game_ended = true
        log(lume.format("[{1}] you win (all enemy units dead)", { self.layer_name }))
        if self.hover_ui ~= nil then
            layer_manager:remove_first()
        end
        local lose_layer = WinLayer()
        layer_manager:transition(self, lose_layer)
        return
    end
    if self.active_mode == 'animation_wait' then
        if self.selection_intention == 'move' then
            if self.selected_unit ~= nil and self.selected_unit.processing_move_queue == false then
                if self.selected_unit.user_controlled == true then
                    local viable_attacks = self:viable_attack_tiles(self.selected_unit)
                    if #viable_attacks > 0 then
                        self.active_mode = 'selection'
                        self.selection_intention = 'attack'
                        self.allowed_tiles = viable_attacks
                    else
                        self.active_mode = 'overview'
                        self.selected_unit = nil
                    end
                else
                    self:enemy_turn_loop()
                end
                
                self:populate_hover_ui()
            end
        elseif self.selection_intention == 'focus_enemy' then
            self:enemy_turn_loop()
        elseif self.selection_intention == 'focus_player' then
            self:start_player_turn()
        elseif self.selection_intention == 'attack' then
            self:combat_phase_atk_cast(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack2' then
            self:combat_phase_atk_receive(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack3' then
            self:combat_phase_post_atk(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack3.5' then
            self:combat_phase_atk_cursor_move(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack4' then
            self:combat_phase_retaliation_damage(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack5' then
            self:combat_phase_ret_cast(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack6' then
            self:combat_phase_ret_receive(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack7' then
            self:combat_phase_post_ret(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack7.5' then
            self:combat_phase_ret_cursor_move(self.selected_unit, self.target_unit)
        elseif self.selection_intention == 'attack8' then
            self:combat_phase_ended(self.selected_unit, self.target_unit)
        end
    end
    
    local window_width = love.graphics.getWidth()
    local window_height = love.graphics.getHeight()
    local cursor_x = x_for_tile(self.cursor_tile_x)
    local cursor_y = y_for_tile(self.cursor_tile_y)
    local cursor_proj_x = x_for_tile(self.cursor_tile_target_x)
    local cursor_proj_y = y_for_tile(self.cursor_tile_target_y)

    if cursor_x ~= cursor_proj_x or cursor_y ~= cursor_proj_y then
        local movespeed = constants.cursor_move_speed
        if self.cursor_is_turbo then
            movespeed = constants.cursor_turbo_speed
        end
        self.cursor_tile_anim_accumulator = self.cursor_tile_anim_accumulator + dt
        local interpolation = self.cursor_tile_anim_accumulator / movespeed
        cursor_x = lume.lerp(cursor_x, cursor_proj_x, interpolation)
        cursor_y = lume.lerp(cursor_y, cursor_proj_y, interpolation)
        if self.cursor_tile_anim_accumulator > movespeed then
            self.cursor_tile_x = self.cursor_tile_target_x
            self.cursor_tile_y = self.cursor_tile_target_y
            self.cursor_tile_anim_accumulator = 0
            self:populate_hover_ui()
        end
    end

    local cursor_width = constants.pixel_tile_width * constants.pixel_integer_scale
    local cursor_height = constants.pixel_tile_height * constants.pixel_integer_scale
    local camera_x = cursor_x - window_width / 2 + cursor_width / 2
    local camera_y = cursor_y - window_height / 2 + cursor_height / 2
    local max_x = x_for_tile(self.tile_width_count) - window_width
    local max_y = y_for_tile(self.tile_height_count) - window_height
    camera_x = lume.clamp(camera_x, camera_x, max_x)
    camera_y = lume.clamp(camera_y, camera_y, max_y)
    camera:setPosition(camera_x, camera_y)

    lume.each(self.units, "update", dt)
end

function SRPGLayer:keypressed(key, scancode, isrepeat)
    self.cursor_is_turbo = isrepeat
    if self.paused == 1 then
        return
    end
    if self.active_mode == 'animation_wait' then
        return
    end
    if self.cursor_tile_x ~= self.cursor_tile_target_x or self.cursor_tile_y ~= self.cursor_tile_target_y then
        return
    end
    
    if key == layer_manager.controls["Up"] then
        self.cursor_tile_target_y = self.cursor_tile_target_y - 1
    elseif key == layer_manager.controls["Down"] then
        self.cursor_tile_target_y = self.cursor_tile_target_y + 1
    elseif key == layer_manager.controls["Left"] then
        self.cursor_tile_target_x = self.cursor_tile_target_x - 1
    elseif key == layer_manager.controls["Right"] then
        self.cursor_tile_target_x = self.cursor_tile_target_x + 1
    elseif not keyrepeat and key == layer_manager.controls["Back"] then
        if self.active_mode == 'selection' then
            self.active_mode = 'overview'
            self.allowed_tiles = {}
        end
    elseif not keyrepeat and key == layer_manager.controls["Confirm"] then
        if self.active_mode == 'overview' then
            self:confirm_pressed_overview()
        elseif self.active_mode == 'selection' and self.selection_intention == 'move' then
            self:confirm_move_selection()
        elseif self.active_mode == 'selection' and self.selection_intention == 'attack' then
            self:confirm_user_attack_selection()
        end
    elseif not keyrepeat and key == 'l' then
        log(lume.format("[{1}] x = {2}, y = {3}", { self.layer_name, self.cursor_tile_x, self.cursor_tile_y }))
    elseif not keyrepeat and key == 'm' then
        self:mana_report()
    end

    self.cursor_tile_target_x = lume.clamp(self.cursor_tile_target_x, 0, self.tile_width_count - 1)
    self.cursor_tile_target_y = lume.clamp(self.cursor_tile_target_y, 0, self.tile_height_count - 1)

    if self.active_mode == 'selection' then
        if lume.any(self.allowed_tiles, function(t) return t.x == self.cursor_tile_target_x and t.y == self.cursor_tile_target_y end) == false then
            self.cursor_tile_target_x = self.cursor_tile_x
            self.cursor_tile_target_y = self.cursor_tile_y
        end
        if self.selected_unit ~= nil and (self.cursor_tile_x ~= self.cursor_tile_target_x or self.cursor_tile_y ~= self.cursor_tile_target_y) then
            self.selected_unit:queue_move(self.cursor_tile_target_x, self.cursor_tile_target_y)
        end
    end
    
end

function SRPGLayer:keyreleased(key, scancode)
    self.cursor_is_turbo = false
    return
end

-- FUNCTIONALITY

function SRPGLayer:confirm_pressed_overview()
    local that = self
    local mana_callback = function(ability)
        if ability == nil then
            layer_manager:remove_first()
            return
        end

        if self.player_red_mana >= ability.r_cost and self.player_green_mana >= ability.g_cost and self.player_blue_mana >= ability.b_cost then
            self.player_red_mana = self.player_red_mana - ability.r_cost
            self.player_green_mana  = self.player_green_mana - ability.g_cost
            self.player_blue_mana = self.player_blue_mana - ability.b_cost
            if ability.name == 'Double Strike' then
                that.selected_unit.has_doublestr = true
            elseif ability.name == 'Reflector Gate' then
                that.selected_unit.has_reflect = true
            elseif ability.name == 'Healing Aura' then
                that.selected_unit.has_healaura = true
            elseif ability.name == 'Hunger Blade' then
                that.selected_unit.has_hungering = true
            end
            layer_manager:remove_first()
        else
            -- play a failure sound or something
            log("insufficient mana")
        end
    end
    local menu_callback = function(menu_option)
        if menu_option == 'Move' then
            that.active_mode = 'selection'
            that.selection_intention = 'move'
            that.allowed_tiles = that:viable_move_tiles(that.selected_unit)
            layer_manager:remove_first()
        elseif menu_option == 'Attack' then
            that.active_mode = 'selection'
            that.selection_intention = 'attack'
            that.allowed_tiles = that:viable_attack_tiles(that.selected_unit)
            layer_manager:remove_first()
        elseif menu_option == 'Sacrifice' then
            that:sacrifice_unit(that.selected_unit)
            layer_manager:remove_first()
        elseif menu_option == 'Wait' then
            that.selected_unit.moved_this_turn = true
            layer_manager:remove_first()
        elseif menu_option == 'Pass Turn' then
            that:start_enemy_turn()
            layer_manager:remove_first()
        elseif menu_option == 'Special' then
            layer_manager:remove_first()
            local mana_menu = ManaAbilityMenuLayer(that.selected_unit, mana_callback)
            mana_menu.red_available = that.player_red_mana
            mana_menu.green_available = that.player_green_mana
            mana_menu.blue_available = that.player_blue_mana
            layer_manager:prepend(mana_menu)
        elseif menu_option == nil then
            layer_manager:remove_first()
        end
        
    end
    local unit_menu = nil
    local units = lume.filter(self.units, function(u) return u.tile_x == self.cursor_tile_x and u.tile_y == self.cursor_tile_y end)
    if #units > 0 and units[1].user_controlled == true and units[1].moved_this_turn == false then
        self.selected_unit = units[1]
        local mode = nil
        local viable_attacks = self:viable_attack_tiles(units[1])
        if units[1].is_hero == true then
            mode = 'hero_unit'
        else
            mode = 'basic_unit'
        end
        if #viable_attacks == 0 then
            mode = mode .. '_no_atk'
        end
        unit_menu = UnitSelectMenuLayer(mode, menu_callback)
    else
        -- no selectable units, pop a menu to end turn
        unit_menu = UnitSelectMenuLayer('blank_tile', menu_callback)
    end
    layer_manager:prepend(unit_menu)
end

function SRPGLayer:confirm_move_selection()
    self.active_mode = 'animation_wait'
    self.selected_unit.processing_move_queue = true
end

function SRPGLayer:confirm_user_attack_selection()
    local attacker = self.selected_unit
    local target_units = lume.filter(self.units, function(u) return u.user_controlled == not attacker.user_controlled and u.tile_x == self.cursor_tile_x and u.tile_y == self.cursor_tile_y end)
    local defender = lume.first(target_units)
    self:confirm_attack_selection(attacker, defender)
end

function SRPGLayer:confirm_attack_selection(attacker, defender) 
    self.selected_unit = attacker
    self.selection_intention = 'attack'
    log(lume.format("[{1}] entering combat", { self.layer_name }))
    attacker.moved_this_turn = true
    log(lume.format("[{1}] attacker: {2}", { self.layer_name, attacker.unit_name }))
    if defender ~= nil then
        self.target_unit = defender
        log(lume.format("[{1}] defender: {2}", { self.layer_name, defender.unit_name }))
        self.active_mode = 'animation_wait'
        self:combat_phase_initial_damage(attacker, defender)
    else
        log(lume.format("[{1}] no unit targeted", { self.layer_name }))
        self:combat_phase_ended(attacker, nil)
    end
end

function SRPGLayer:combat_phase_initial_damage(attacker, defender)
    -- Deal the initial damage
    local damage = attack_formula(attacker.atk, defender.def)

    if attacker.has_doublestr == true then
        local double_dmg = attack_formula(attacker.atk, defender.def)
        local old_dmg = damage
        damage = damage + double_dmg
        log(lume.format("[{1}] double strike proc on attacker {2}, damage now {3}, was {4}", { self.layer_name, attacker.unit_name, damage, old_dmg }))
    end
    if defender.has_reflect == true then
        local reflect_dmg = lume.round(damage * 0.5)
        local old_dmg = damage
        damage = damage - reflect_dmg
        attacker.hp = attacker.hp - reflect_dmg
        log(lume.format("[{1}] reflection gate proc on defender {2}, damage now {3}, was {4}, attacker takes {5}", { self.layer_name, defender.unit_name, damage, old_dmg, reflect_dmg }))
    end
    if attacker.has_hungering == true then
        local hungering_heal = lume.round(damage * 0.5)
        log(lume.format("[{1}] hungering blade proc on attacker {2}, heals for {3}", { self.layer_name, attacker.unit_name, hungering_heal }))
        attacker.hp = attacker.hp + hungering_heal
        if attacker.hp > attacker.max_hp then
            attacker.hp = attacker.max_hp
        end
    end
    log(lume.format("[{1}] {2} deals {4} damage to {3}", { self.layer_name, attacker.unit_name, defender.unit_name, damage }))
    defender.hp = defender.hp - damage
    
    if attacker.tile_x < defender.tile_x then
        attacker.facing_left = false
        defender.facing_left = true
    elseif defender.tile_x < attacker.tile_x then
        attacker.facing_left = true
        defender.facing_left = false
    else
        attacker.facing_left = false
        defender.facing_left = false
    end
end

function SRPGLayer:combat_phase_atk_cast(attacker, defender)
    -- Attacker casts spell
    local that = self
    attacker:enter_cast_animation(function() 
        attacker.active_animation = 'walk_animation'
        that.selection_intention = 'attack2' 
    end)
end

function SRPGLayer:combat_phase_atk_receive(attacker, defender)
    -- Defender receives damage, attacker returns to normal
    local that = self
    attacker.active_animation = 'walk_animation'
    that.selection_intention = 'stall'
    defender:enter_damage_animation(function()
        defender.active_animation = 'walk_animation'
        that.hover_ui:animate_to(defender.hp, function()
            that.selection_intention = 'attack3'
        end)
    end)
end

function SRPGLayer:combat_phase_post_atk(attacker, defender)
    log("post atk")
    -- If defender should be dead, purge the unit from storage
    -- Otherwise, restore the defender's walk animation and move to next phase
    if defender.hp <= 0 then
        defender.purge = true
        self:combat_phase_ended(attacker, defender)
    else
        self.selection_intention = 'attack3.5'
    end
end

function SRPGLayer:combat_phase_atk_cursor_move(attacker, defender)
    log("atk cursor move")
    if self:wait_until_cursor_moved_to_point(attacker.tile_x, attacker.tile_y, 'attack3.5') == true then
        return
    end
    self:populate_hover_ui()
    self.selection_intention = 'attack4'
end

function SRPGLayer:combat_phase_retaliation_damage(attacker, defender)
    -- Deal the initial damage
    local damage = attack_formula(defender.atk, attacker.def)
    log(lume.format("[{1}] {2} deals {4} damage to {3}", { self.layer_name, defender.unit_name, attacker.unit_name, damage }))
    attacker.hp = attacker.hp - damage
    self.selection_intention = 'attack5'
end

function SRPGLayer:combat_phase_ret_cast(attacker, defender)
    -- Defender casts spell
    local that = self
    defender:enter_cast_animation(function() 
        defender.active_animation = 'walk_animation'
        that.selection_intention = 'attack6' 
    end)
end

function SRPGLayer:combat_phase_ret_receive(attacker, defender)
    local that = self
    -- Attacker receives damage, defender returns to normal
    that.selection_intention = 'stall'
    attacker:enter_damage_animation(function()
        attacker.active_animation = 'walk_animation'
        that.hover_ui:animate_to(defender.hp, function()
            that.selection_intention = 'attack7'
        end)
    end)
end

function SRPGLayer:combat_phase_post_ret(attacker, defender)
    if attacker.hp <= 0 then
        attacker.purge = true
        self:combat_phase_ended(attacker, defender)
    else
        self.selection_intention = 'attack7.5'
    end
end

function SRPGLayer:combat_phase_ret_cursor_move(attacker, defender)
    if self:wait_until_cursor_moved_to_point(attacker.tile_x, attacker.tile_y, 'attack7.5') == true then
        return
    end
    self:populate_hover_ui()
    self.selection_intention = 'attack8'
end

function SRPGLayer:combat_phase_ended(attacker, defender)
    if attacker.user_controlled == true then
        -- perform cleanup and regain control
        self.active_mode = 'overview'
        self:populate_hover_ui()
    else
        self:enemy_turn_loop()
    end
end

function SRPGLayer:viable_attack_tiles(unit)
    -- return immediately adjacent tiles with attackable units
    local opposite_player = not unit.user_controlled
    local left_x = unit.tile_x - 1
    local right_x = unit.tile_x + 1
    local up_y = unit.tile_y - 1
    local down_y = unit.tile_y + 1
    local units = lume.filter(self.units, function(u)
        return u.user_controlled == opposite_player and
            ((u.tile_x == left_x and u.tile_y == unit.tile_y) or
            (u.tile_x == right_x and u.tile_y == unit.tile_y) or
            (u.tile_x == unit.tile_x and u.tile_y == up_y) or
            (u.tile_x == unit.tile_x and u.tile_y == down_y))
    end)
    local tiles = lume.map(units, function(u) return { x = u.tile_x, y = u.tile_y } end)
    if #tiles > 0 then
        table.insert(tiles, { x = unit.tile_x, y = unit.tile_y })
    end
    return tiles
end

function SRPGLayer:viable_move_tiles(unit)
    local raw_tiles = unit:raw_allowed_tiles()
    local filtered_tiles = lume.filter(raw_tiles, function(t)
        return not lume.any(self.units, function(u)
            return u ~= unit and u.tile_x == t.x and u.tile_y == t.y
        end) and not lume.any(self.restricted_tiles, function(rt)
            return rt.x == t.x and rt.y == t.y
        end)
    end)
    return filtered_tiles
end

function SRPGLayer:start_player_turn()
    self.active_mode = 'animation_wait'
    -- move camera to first player unit on start of turn
    local player_units = lume.filter(self.units, function(u) return u.user_controlled == true end)
    local unit = lume.first(player_units)
    if self:wait_until_cursor_moved_to_point(unit.tile_x, unit.tile_y, 'focus_player') == true then
        return
    end
    -- once move complete, reset state and switch to overview mode
    self:reset_player_turn()
    self.active_mode = 'overview'

end

function SRPGLayer:reset_player_turn()
    local player_units = lume.filter(self.units, function(u) return u.user_controlled == true end)
    lume.each(player_units, function(u) u.moved_this_turn = false end)
    self:healing_aura_phase(true)
end

function SRPGLayer:populate_hover_ui()
    local units = lume.filter(self.units, function(u) return u.tile_x == self.cursor_tile_x and u.tile_y == self.cursor_tile_y end)
    if #units > 0 then
        local u = units[1]
        self.hover_ui.show_ui = true
        self.hover_ui.max_hp = u.max_hp
        self.hover_ui.from_hp = u.hp
        self.hover_ui.to_hp = u.hp
        self.hover_ui.atk = u.atk
        self.hover_ui.def = u.def
        self.hover_ui.unit_name = u.unit_name
    else
        self.hover_ui.show_ui = false
    end
end

function SRPGLayer:start_enemy_turn()
    self.active_mode = 'animation_wait'
    local enemy_units = lume.filter(self.units, function(u) return u.user_controlled == false end)
    lume.each(enemy_units, function(u) u.moved_this_turn = false end)
    self:healing_aura_phase(false)
    self:enemy_turn_loop()
end

function SRPGLayer:wait_until_cursor_moved_to_point(x, y, intention)
    if self.cursor_tile_x ~= x or self.cursor_tile_y ~= y then
        self.cursor_tile_target_x = x
        self.cursor_tile_target_y = y
        self.selection_intention = intention
        return true
    end
    return false
end

function SRPGLayer:enemy_turn_loop()
    local remaining_move_units = lume.filter(self.units, function(u) return u.purge == false and u.user_controlled == false and u.moved_this_turn == false end)
    if #remaining_move_units <= 0 then
        self:start_player_turn()
    else
        local unit = lume.first(remaining_move_units)
        local destinations = self:viable_move_tiles(unit)
        local attacks = self:viable_attack_tiles(unit)
        local player_units = lume.filter(self.units, function(u) return u.user_controlled == true end)
        local target_result = enemy_ai_target(unit, attacks, player_units)
        if target_result.type == 'get_closer' then
            -- move then combat if possible
            destinations = lume.sort(destinations, function(a, b)
                return lume.distance(target_result.target.tile_x, target_result.target.tile_y, a.x, a.y) < lume.distance(target_result.target.tile_x, target_result.target.tile_y, b.x, b.y)
            end)
            local destination = lume.first(destinations)
            if self:wait_until_cursor_moved_to_point(destination.x, destination.y, 'focus_enemy') == true then
                return
            end
            unit:queue_move(destination.x, destination.y)
            self.selected_unit = unit
            self.selection_intention = 'move'
            self:confirm_move_selection()
        else
            if self:wait_until_cursor_moved_to_point(unit.tile_x, unit.tile_y, 'focus_enemy') == true then
                return
            end
            self:confirm_attack_selection(unit, target_result.target) 
        end
    end
end

function SRPGLayer:sacrifice_unit(unit)
    local key = ''
    if unit.user_controlled == true then
        key = lume.format("player_{1}_mana", { unit.mana_color })
    else
        key = lume.format("enemy_{1}_mana", { unit.mana_color })
    end
    self[key] = self[key] + 1
    log(lume.format("[{1}] sacrificed {2}, added 1 to {3} (now at {4})", { self.layer_name, unit.unit_name, key, self[key]}))
    unit.hp = 0
    self.active_mode = 'animation_wait'
    self.selection_intention = 'sacrifice'
    unit:enter_sacrifice_animation(function()
        unit.purge = true
        if unit.user_controlled == true then
            self.active_mode = 'overview'
        end
    end)
end

function SRPGLayer:mana_report()
    log(lume.format("[{1}] mana: player ({2}/{3}/{4}), enemy ({5}/{6}/{7})", { self.layer_name, self.player_red_mana, self.player_green_mana, self.player_blue_mana, self.enemy_red_mana, self.enemy_green_mana, self.enemy_blue_mana}))
end

function SRPGLayer:healing_aura_phase(user_controlled)
    local eligible_units = lume.filter(self.units, function(u) return u.user_controlled == user_controlled and u.has_healaura == true end)
    if #eligible_units <= 0 then
        return
    else
        lume.each(eligible_units, function(u)
            local heal_amount = lume.round(u.max_hp * 0.15)
            log(lume.format("[{1}] healing aura proc: {2} heals for {3}", { self.layer_name, u.unit_name, heal_amount }))
            u.hp = u.hp + heal_amount
            if u.hp > u.max_hp then
                u.hp = u.max_hp
            end
        end)
    end
end